<p-toast position="bottom-right"></p-toast>

<div class="mesas-wrapper flex flex-column gap-4">
  <div class="surface-card shadow-2 border-round p-4">
    <div
      class="flex flex-column gap-2 md:flex-row md:align-items-center md:justify-content-between"
    >
      <div>
        <p class="text-sm text-color-secondary m-0 text-uppercase tracking-wide">
          Materias con mesas abiertas
        </p>
        <h2 class="m-0 text-2xl font-semibold">Inscripciones disponibles</h2>
        <p class="text-color-secondary mt-1 mb-0">
          Selecciona la materia para revisar su estado o inscribirte.
        </p>
      </div>
      <div class="flex gap-2 flex-wrap mt-2 md:mt-0">
        <p-button
          type="button"
          label="Actualizar materias"
          icon="pi pi-refresh"
          severity="secondary"
          (onClick)="reloadCourseStatus()"
        />
      </div>
    </div>

    <div *ngIf="courseLoading(); else courseCards" class="flex justify-content-center py-5">
      <p-progressSpinner strokeWidth="3"></p-progressSpinner>
    </div>

    <ng-template #courseCards>
      <div
        *ngIf="!courseCardsVm().length"
        class="text-center py-4 text-color-secondary"
      >
        No encontramos materias con mesas publicadas para tu usuario.
      </div>

      <div *ngIf="courseCardsVm().length" class="flex flex-column gap-3 mt-3">
        <div
          class="course-card border-1 surface-border border-round px-3 py-3 flex flex-column gap-3 md:flex-row md:align-items-center"
          *ngFor="let card of courseCardsVm(); trackBy: trackCourseCard"
        >
          <div class="flex flex-column gap-1 flex-1">
            <span class="course-label">Nombre</span>
            <div class="course-name-field border-1 surface-border border-round px-3 py-2">
              <p class="m-0 text-lg font-semibold">
                {{ card.subjectName }}
              </p>
              <small class="text-color-secondary" *ngIf="card.commissionLabel">
                Comision {{ card.commissionLabel }}
              </small>
            </div>
          </div>
          <div class="course-actions flex gap-2 flex-wrap md:justify-content-end">
            <p-button
              type="button"
              size="small"
              [label]="card.statusLabel"
              [severity]="card.statusSeverity"
              styleClass="text-sm text-uppercase font-semibold"
            />
            <p-button
              type="button"
              size="small"
              label="Ver mesas"
              icon="pi pi-calendar"
              severity="secondary"
              (onClick)="onViewCourseTables(card)"
            />
            <p-button
              *ngIf="card.showEnrollCta"
              type="button"
              size="small"
              label="Inscribirme al curso"
              icon="pi pi-check"
              (onClick)="onCourseEnroll(card)"
            />
          </div>
        </div>
      </div>
    </ng-template>
  </div>

  <div
    id="mesas-disponibles"
    class="surface-card shadow-2 border-round p-0 overflow-hidden mesas-disponibles"
  >
    <div
      class="flex align-items-center justify-content-between px-4 py-3 border-bottom surface-border-light"
    >
      <div>
        <h3 class="m-0 text-lg font-semibold">Mesas disponibles</h3>
        <small class="text-color-secondary"
          >{{ rows().length }} llamados publicados</small
        >
      </div>
      <p-button
        type="button"
        label="Actualizar"
        icon="pi pi-refresh"
        size="small"
        severity="secondary"
        (onClick)="loadTables()"
      />
    </div>

    <div
      *ngIf="loading(); else mesasTable"
      class="flex justify-content-center py-5"
    >
      <p-progressSpinner
        styleClass="mesas-spinner"
        strokeWidth="3"
      ></p-progressSpinner>
    </div>

    <ng-template #mesasTable>
      <div
        *ngIf="rows().length === 0"
        class="text-center py-5 px-4 text-color-secondary"
      >
        No hay mesas disponibles con los filtros seleccionados. Proba ajustarlos
        o consulta mas tarde.
      </div>

      <p-table
        *ngIf="rows().length > 0"
        [value]="rows()"
        [responsiveLayout]="'scroll'"
        class="mesas-table"
        stripedRows
      >
        <ng-template pTemplate="header">
          <tr>
            <th>Materia</th>
            <th>Llamado</th>
            <th>Fecha</th>
            <th>Ventana</th>
            <th>Cupo</th>
            <th class="text-center">Accion</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-row>
          <tr>
            <td>
              <div class="subject-cell">
                <span class="subject-name">{{ row.subjectName }}</span>
                <small class="text-color-secondary" *ngIf="row.commissionLabel">
                  Comision {{ row.commissionLabel }}
                </small>
                <div class="mt-1" *ngIf="isEnrolled(row)">
                  <p-tag
                    severity="success"
                    value="Inscripto"
                    styleClass="text-xs"
                  ></p-tag>
                </div>
              </div>
            </td>
            <td>
              <div class="flex align-items-center gap-2">
                <span>{{ row.call.label }}</span>
                <p-tag
                  *ngIf="row.call.additional"
                  severity="info"
                  value="Llamado adicional"
                  styleClass="text-xs"
                />
              </div>
            </td>
            <td>
              {{ row.call.examDate | date: "dd/MM/yyyy" }}
            </td>
            <td>
              <div class="flex flex-column gap-1">
                <p-tag
                  [severity]="stateSeverity(row.windowState)"
                  [value]="stateLabel(row.windowState)"
                />
                <small class="text-color-secondary">{{
                  row.windowRange
                }}</small>
              </div>
            </td>
            <td>
              <div class="flex flex-column gap-1">
                <span>{{ row.quotaText }}</span>
                <small class="text-color-secondary" *ngIf="row.call.quotaTotal">
                  Actualizado por Secretaria
                </small>
              </div>
            </td>
            <td class="text-center">
              <ng-container *ngIf="!isEnrolled(row); else enrolledTag">
                <p-button
                  type="button"
                  label="Inscribirme"
                  icon="pi pi-check"
                  size="small"
                  [disabled]="isActionBlocked(row)"
                  [pTooltip]="blockTooltip(row) || ''"
                  tooltipPosition="top"
                  (onClick)="onEnroll(row, $event)"
                  ariaLabel="Inscribirme a {{ row.subjectName }} - {{
                    row.call.label
                  }}"
                />
              </ng-container>
              <ng-template #enrolledTag>
                <ng-container *ngIf="isStudent; else enrolledBadge">
                  <p-button
                    type="button"
                    label="Desinscribirme"
                    icon="pi pi-times"
                    size="small"
                    severity="danger"
                    (onClick)="onUnenroll(row)"
                    ariaLabel="Desinscribirme de {{ row.subjectName }} - {{
                      row.call.label
                    }}"
                  />
                </ng-container>
                <ng-template #enrolledBadge>
                  <p-tag severity="success" value="Inscripto" />
                </ng-template>
              </ng-template>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </ng-template>
  </div>

  <app-block-message
    *ngIf="blockAlert() as block"
    class="mesas-block"
    [title]="block.title"
    [message]="block.message"
    [variant]="block.variant"
    [reasonCode]="block.reasonCode"
    [autoFocus]="true"
    [actions]="defaultBlockActions"
  ></app-block-message>
</div>

<p-dialog
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [closeOnEscape]="true"
  [dismissableMask]="true"
  [style]="{ width: '420px' }"
  [header]="'Confirmar inscripcion'"
  [(visible)]="dialogVisible"
  (onHide)="cancelDialog()"
>
  <p class="mb-3">
    Confirmas la inscripcion a
    <strong>{{ selectedRow?.subjectName }}</strong> en el
    <strong>{{ selectedRow?.call?.label }}</strong
    >?
  </p>
  <ul class="confirmation-list">
    <li>
      <strong>Fecha:</strong>
      {{ selectedRow?.call?.examDate | date: "dd/MM/yyyy" }}
    </li>
    <li><strong>Ventana:</strong> {{ selectedRow?.windowRange }}</li>
  </ul>
  <ng-template pTemplate="footer">
    <div class="flex justify-content-end gap-2">
      <p-button
        type="button"
        label="Cancelar"
        severity="secondary"
        (onClick)="cancelDialog()"
      />
      <p-button
        type="button"
        label="Confirmar"
        icon="pi pi-check"
        (onClick)="confirmEnroll()"
      />
    </div>
  </ng-template>
</p-dialog>
