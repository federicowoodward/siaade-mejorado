<div class="m-w-custom">
  <p-button label="Volver" icon="pi pi-arrow-left" (onClick)="back()" />
  <div class="flex justify-content-between align-items-center mb-3">
    <h2 class="m-0">Notas • {{ subjectName() }}</h2>
    <div class="flex gap-2">
      <p-button
        label="Agregar examen"
        icon="pi pi-plus"
        (onClick)="openAddExam()"
      />
    </div>
  </div>

  <p-table
    [value]="studentsInSubject()"
    [paginator]="true"
    [rows]="10"
    responsiveLayout="scroll"
>
<ng-template pTemplate="header">
  <tr>
    <th [attr.rowspan]="hasPracticalExam() ? 2 : 1" style="width: 6rem">Alumno</th>
    <ng-container *ngFor="let ex of exams()">
      <th [attr.colspan]="(ex.type ?? 'comun') === 'practico' ? (ex.gradesCount ?? 1) + 1 : 1"
          [ngClass]="examTypeColors[ex.type ?? 'comun']"
          [attr.rowspan]="(ex.type ?? 'comun') === 'practico' ? 1 : 2">
        <div class="flex flex-column">
          <span class="font-medium">{{ ex.title }}</span>
          <small class="text-color-secondary">{{ ex.date }}</small>
        </div>
      </th>
    </ng-container>
  </tr>
  <tr *ngIf="hasPracticalExam()">
    <ng-container *ngFor="let ex of exams()">
      <ng-container *ngIf="(ex.type ?? 'comun') === 'practico'">
        <th *ngFor="let nota of [].constructor(ex.gradesCount ?? 1); let i = index"class="nota-header"> 
        Nota {{ i + 1 }}
        </th>
        
        <th class="nota-header">Promedio</th>
      </ng-container>
    </ng-container>
  </tr>
</ng-template>



    <ng-template pTemplate="body" let-row>
  <tr>
    <td>
      <div class="flex flex-column">
        <span class="font-medium">{{ row.name }}</span>
        <small class="text-color-secondary">Legajo: {{ row.legajo }}</small>
      </div>
    </td>

    <ng-container *ngFor="let ex of exams()">
  <ng-container *ngIf="(ex.type ?? 'comun') === 'practico'">
    <td *ngFor="let nota of [].constructor(ex.gradesCount ?? 1); let i = index">
      <p-inputNumber
        [min]="0"
        [max]="10"
        [useGrouping]="false"
        mode="decimal"
        [ngModel]="getScore(ex.id, row.userId, i)"
        (ngModelChange)="setScore(ex.id, row.userId, i, $event)"
        inputStyleClass="w-6rem"
        [showButtons]="false"
      ></p-inputNumber>
    </td>
    <td>
          <p-inputNumber
            [ngModel]="getAverage(ex.id, row.userId)"
            mode="decimal"
            [disabled]="true"
            inputStyleClass="w-6rem"
          ></p-inputNumber>
        </td>
      </ng-container>

      <td *ngIf="(ex.type ?? 'comun') !== 'practico'">
        <p-inputNumber
          [min]="0"
          [max]="10"
          [useGrouping]="false"
          mode="decimal"
          [ngModel]="getScore(ex.id, row.userId, 0)"
          (ngModelChange)="setScore(ex.id, row.userId, 0, $event)"
          inputStyleClass="w-6rem"
          [showButtons]="false"
        ></p-inputNumber>
      </td>
    </ng-container>
  </tr>
</ng-template>


  </p-table>

  <div class="flex justify-end gap-2 mt-3">
    <p-button
      label="Guardar cambios"
      icon="pi pi-check"
      [disabled]="true"
      pTooltip="MVP: sin persistencia"
    />
  </div>
</div>

<p-dialog
  [header]="'Agregar examen'"
  [visible]="showAddExam()"
  (visibleChange)="showAddExam.set($event)"
  [modal]="true"
  [style]="{ width: '480px', maxWidth: '95vw' }"

>
<div>
    <label for="examType" class="block mb-1">Tipo de examen</label>
    <p-selectButton
      id="examType"
      [(ngModel)]="newExamType"
      [options]="examTypes"
      optionLabel="label"
      optionValue="value"
      class="w-full"
    ></p-selectButton>

   <div *ngIf="newExamType === 'practico'" class="mt-3">
    <label for="gradesCount" class="block mb-1">Notas</label>
    <p-selectButton
      id="gradesCount"
      [(ngModel)]="numberOfPracticalGrades"
      [options]="practicalGradesOptions"
      optionLabel="label"
      optionValue="value"
      class="w-full"
    ></p-selectButton>
  </div>

  <div class="flex flex-column gap-3">
    <div>
      <label class="block mb-1">Título</label>
      <input
        pInputText
        class="w-full"
        [(ngModel)]="newExamTitle"
        placeholder="Ej: Parcial 2"
      />
    </div>
    <div>
      <label class="block mb-1">Fecha</label>
      <input
        type="date"
        class="w-full p-inputtext p-component"
        [(ngModel)]="newExamDate"
      />
    </div>
  </div>
</div>
  <ng-template pTemplate="footer">
    <p-button
      label="Cancelar"
      severity="secondary"
      (onClick)="showAddExam.set(false)"
    />
    <p-button label="Agregar" icon="pi pi-check" (onClick)="addExamConfirm()" />
  </ng-template>
<p-dialog/>
