<div class="notices-page">
  <h2 class="page-title">
    <i class="pi pi-bell text-primary mr-2"></i>
    Avisos (Administracion)
  </h2>

  <div
    class="new-notice-form"
    *appCanAnyRole="[ROLE.SECRETARY, ROLE.PRECEPTOR, ROLE.EXECUTIVE_SECRETARY]"
  >
    <input
      type="text"
      placeholder="Titulo"
      [(ngModel)]="newNotice.title"
      class="p-inputtext"
      blockedAction
    />

    <p-editor
      [(ngModel)]="newNotice.content"
      [style]="{ height: '200px' }"
      placeholder="Escribi el contenido del aviso."
      blockedAction
    ></p-editor>

    <label class="mt-2">Visible para:</label>
    <select [(ngModel)]="newNotice.visibleFor" (ngModelChange)="onVisibleForChange()">
      <option value="all">Todos</option>
      <option value="student">Alumnos</option>
      <option value="teacher">Profesores</option>
    </select>

    <div class="year-selector" *ngIf="newNotice.visibleFor === 'student' && availableYears().length > 0">
      <label>Años destino</label>
      <select multiple [(ngModel)]="selectedYearNumbers" (change)="onYearSelectionChange($event)">
        <option
          *ngFor="let year of availableYears()"
          [ngValue]="year"
        >
          {{ year }}° año
        </option>
      </select>
      <small>Si no seleccionás ningún año se publicará para todos los años.</small>
    </div>

    <div class="commission-selector" *ngIf="segmentByCommission()">
      <label>comisiones destino</label>
      <select multiple [(ngModel)]="selectedCommissionIds">
        <option
          *ngFor="let option of commissionOptions()"
          [ngValue]="option.id"
        >
          {{ option.label }}
        </option>
      </select>
      <small>Si no seleccionás ninguna comision se publicará para todas.</small>
    </div>

    <button
      pButton
      type="button"
      label="Publicar"
      (click)="addNotice()"
      class="mt-2"
      blockedAction
    ></button>
  </div>

  <ul class="notices-list">
    <li *ngFor="let n of notices()">
      <div class="notice-item">
        <h3>{{ n.title }}</h3>
        <div class="content" [innerHTML]="n.content"></div>
        <small class="meta">
          Destinatarios:
          {{
            n.visibleFor === 'student'
              ? 'Alumnos'
              : n.visibleFor === 'teacher'
                ? 'Docentes'
                : 'Todos'
          }}
          · {{ n.createdBy }} · {{ n.createdAt | date: 'dd/MM/yyyy' }}
        </small>
        <div class="commission-targets" *ngIf="segmentByCommission()">
          <ng-container *ngIf="n.hasCommissionFilter; else allCommissionsTpl">
            <span
              class="commission-chip"
              *ngFor="let target of n.commissionTargets"
            >
              {{ target.label }}
            </span>
          </ng-container>
          <ng-template #allCommissionsTpl>
            <span class="commission-chip commission-chip--all">
              Todas las comisiones
            </span>
          </ng-template>
        </div>

        <button
          *appCanAnyRole="[ROLE.SECRETARY, ROLE.PRECEPTOR, ROLE.EXECUTIVE_SECRETARY]"
          pButton
          type="button"
          label="Eliminar"
          class="p-button-danger mt-2"
          (click)="deleteNotice(n.id)"
          blockedAction
        ></button>
      </div>
    </li>
  </ul>
</div>

