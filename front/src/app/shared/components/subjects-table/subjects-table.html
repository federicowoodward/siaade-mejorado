<p-table
  [value]="basicSubjects()"
  responsiveLayout="scroll"
  styleClass="p-datatable-sm p-datatable-gridlines"
>
  <ng-template pTemplate="header">
    <tr>
      <th>Asignatura</th>
      <th style="width: 220px; text-align: center">Acciones</th>
    </tr>
  </ng-template>

  <ng-template pTemplate="body" let-subject>
    <tr>
      <td>{{ subject.name }}</td>
      <td class="flex w-18rem gap-4">
        <button
          pButton
          type="button"
          label="Comisiones"
          (click)="viewComissions(subject.id)"
          blockedAction
        ></button>
        <button
          pButton
          type="button"
          class="p-ml-2"
          label="Situacion academica"
          (click)="viewStatus(subject.id)"
          blockedAction
        ></button>
      </td>
    </tr>
  </ng-template>
</p-table>
<p-dialog
  [modal]="true"
  [(visible)]="dialogTeachers().visible"
  (onHide)="closeTeachersDialog()"
  [style]="{ width: '78rem', maxWidth: '95vw' }"
  [draggable]="false"
  [resizable]="false"
  [contentStyle]="{ 'max-height': '70vh', overflow: 'auto' }"
  [header]="dialogData()?.subject?.name && ('Comisiones: ' + dialogData()?.subject?.name)"
>
  <!-- Loading -->
  <div *ngIf="dialogLoading()" class="p-4 flex align-items-center gap-2">
    <i class="pi pi-spin pi-spinner" style="font-size: 1.2rem"></i>
    <span>Cargando comisiones...</span>
  </div>

  <!-- Error -->
  <div *ngIf="!dialogLoading() && dialogError()" class="p-3">
    <p style="color: var(--red-500)">{{ dialogError() }}</p>
    <button
      pButton
      label="Reintentar"
      icon="pi pi-refresh"
      (click)="viewComissions(dialogTeachers().subjectId!)"
    ></button>
  </div>

  <!-- Data -->
  <ng-container
    *ngIf="!dialogLoading() && !dialogError() && dialogData() as data"
  >
    <ng-container *ngIf="data.commissions.length; else emptyStateTpl">
      <div class="flex flex-column gap-4">
        <!-- Comisión -->
        <div *ngFor="let c of data.commissions" class="flex flex-column gap-3">
          <h4 class="m-0">Comisión {{ c.commission.letter || '—' }}</h4>

          <!-- Grid de tarjetas -->
          <div class="col-12" *ngFor="let t of c.teachers">
            <p-card
              [header]="'Profesor/a: ' + t.name"
              [subheader]="t.email"
              class="h-full flex flex-column"
            >
              <ng-template pTemplate="content">
                <div class="text-600 text-sm">CUIL</div>
                <div class="text-900 text-base font-medium">
                  {{ t.cuil || '—' }}
                </div>
              </ng-template>

              <ng-template pTemplate="footer">
                <div class="flex gap-2 justify-content-end flex-wrap">
                  <button
                    pButton
                    label="Ver perfil"
                    icon="pi pi-user"
                    class="p-button-outlined"
                    (click)="goToTeacher(t.teacherId)"
                    blockedAction
                  ></button>

                  <button
                    pButton
                    class="p-button-warning"
                    label="Cambiar"
                    icon="pi pi-arrow-right-arrow-left"
                    (click)="startChangeTeacher(data.subject.id, c.commission.id, t.teacherId)"
                    blockedAction
                  ></button>
                </div>
              </ng-template>
            </p-card>
          </div>
        </div>
      </div>
    </ng-container>

    <ng-template #emptyStateTpl>
      <div class="p-3">
        No hay comisiones/docentes asignados a esta materia.
      </div>
    </ng-template>
  </ng-container>

  <ng-template pTemplate="footer">
    <button
      pButton
      label="Cerrar"
      icon="pi pi-times"
      (click)="closeTeachersDialog()"
    ></button>
  </ng-template>
</p-dialog>

<!-- Diálogo cambio de docente -->
<p-dialog
  [modal]="true"
  [(visible)]="changeTeacherDialog().visible"
  (onHide)="closeChangeTeacherDialog()"
  [style]="{ width: '32rem', maxWidth: '95vw' }"
  [draggable]="false"
  [resizable]="false"
  header="Cambiar docente"
>
  <div
    *ngIf="changeTeacherDialog().loading"
    class="p-3 flex gap-2 align-items-center"
  >
    <i class="pi pi-spin pi-spinner"></i>
    <span>Cargando docentes...</span>
  </div>
  <div *ngIf="!changeTeacherDialog().loading">
    <p class="mb-2">Seleccione el nuevo docente para la comisión.</p>
    <select
      class="p-inputtext p-component"
      [(ngModel)]="selectedNewTeacher"
      style="width: 100%"
    >
      <option [ngValue]="null" disabled selected>Seleccione docente</option>
      <option *ngFor="let opt of teacherOptions()" [value]="opt.value">
        {{ opt.label }}
      </option>
    </select>
  </div>
  <ng-template pTemplate="footer">
    <button
      pButton
      label="Cancelar"
      class="p-button-text"
      (click)="closeChangeTeacherDialog()"
    ></button>
    <button
      pButton
      label="Guardar"
      [disabled]="!selectedNewTeacher"
      (click)="confirmChangeTeacher()"
      icon="pi pi-check"
      blockedAction
    ></button>
  </ng-template>
</p-dialog>
